<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Padsala | High Command Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            padding: 4rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 1.2rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-table th {
            color: var(--primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }
    </style>
</head>

<body class="galaxy-bg">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4rem;">
        <div>
            <h1 class="text-gradient">High Command</h1>
            <p style="opacity: 0.6;">System Overseer Interface</p>
        </div>
        <a href="/" class="control-btn" style="text-decoration: none;">Return to Bridge</a>
    </header>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 4rem;">
        <!-- Generate User -->
        <div class="glass-card" style="padding: 2.5rem;">
            <h3 style="margin-top: 0; color: var(--primary);">Generate Recruit</h3>
            <p style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 2rem;">Manually deploy a new student identity to
                the system.</p>

            <div class="input-group">
                <input type="text" id="new-username" class="stream-input" placeholder=" " required>
                <label class="input-label">Username</label>
            </div>

            <div class="input-group">
                <input type="password" id="new-password" class="stream-input" placeholder=" " required>
                <label class="input-label">Access Key</label>
            </div>

            <button class="btn-primary" onclick="generateUser()" style="width: 100%; justify-content: center;">
                Deploy Identity <i data-lucide="user-plus"></i>
            </button>
        </div>

        <!-- System Stats -->
        <div class="glass-card"
            style="padding: 2.5rem; display: flex; align-items: center; justify-content: space-around;">
            <div style="text-align: center;">
                <h3 style="margin: 0; opacity: 0.6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    Registered Recruits</h3>
                <div style="font-size: 4rem; font-weight: 900; color: var(--primary); line-height: 1;">{{ users|length
                    }}</div>
            </div>
            <div style="height: 80px; width: 1px; background: rgba(255,255,255,0.1);"></div>
            <div style="text-align: center;">
                <h3 style="margin: 0; opacity: 0.6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    Active Timelines</h3>
                <div style="font-size: 4rem; font-weight: 900; color: var(--accent-pink); line-height: 1;">{{
                    total_schedules }}</div>
            </div>
            <div style="height: 80px; width: 1px; background: rgba(255,255,255,0.1);"></div>
            <div style="text-align: center;">
                <h3 style="margin: 0; opacity: 0.6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    System Status</h3>
                <div style="color: #22c55e; font-weight: 800; font-size: 1.2rem; margin-top: 1rem;">ONLINE <i
                        data-lucide="activity"></i></div>
            </div>
        </div>
    </div>

    <!-- User Directory -->
    <div class="glass-card" style="padding: 2.5rem;">
        <h2 style="margin-top: 0; margin-bottom: 2rem; font-size: 1.5rem; opacity: 0.9;">Recruit Directory</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Mission ID</th>
                    <th>Registry Date</th>
                    <th>Timelines</th>
                    <th style="text-align: right;">Operations</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-row-{{ user.id }}">
                    <td style="font-weight: 700;">@{{ user.username }}</td>
                    <td style="opacity: 0.6; font-size: 0.9rem;">{{ user.created_at }}</td>
                    <td>
                        <span
                            style="background: rgba(139, 92, 246, 0.1); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.8rem;">
                            {{ user.timeline_count }} Active
                        </span>
                    </td>
                    <td style="text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button class="control-btn" onclick="resetPassword({{ user.id }}, '@{{ user.username }}')"
                            style="border-color: rgba(255,255,255,0.1); padding: 6px 12px; font-size: 0.8rem;">
                            <i data-lucide="key" style="width: 14px;"></i> Reset
                        </button>
                        <button class="control-btn" onclick="deleteUser({{ user.id }}, '@{{ user.username }}')"
                            style="color: #ef4444; border-color: rgba(239, 68, 68, 0.2); padding: 6px 12px; font-size: 0.8rem;">
                            <i data-lucide="trash-2" style="width: 14px;"></i> Wipe
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        lucide.createIcons();

        async function resetPassword(id, name) {
            const newPass = prompt(`Enter new Access Key for recruit ${name}:`);
            if (!newPass) return;

            try {
                const res = await fetch('/admin/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: id, new_password: newPass })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Access Key for ${name} has been updated.`);
                } else {
                    alert("Authorization failed or link broken.");
                }
            } catch (e) { alert("Comm error"); }
        }

        async function generateUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            if (!username || !password) return alert("Credentials required for deployment.");

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Identity @${username} has been deployed to the Padsala network.`);
                    location.reload();
                } else {
                    alert(data.error);
                }
            } catch (e) { alert("Deployment connection failure."); }
        }

        async function deleteUser(id, name) {
            if (!confirm(`WARNING: You are about to wipe all data for recruit ${name}. This action is permanent and will delete all their timelines. Proceed?`)) return;

            try {
                const res = await fetch('/admin/api/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: id })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById(`user-row-${id}`).style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById(`user-row-${id}`).remove();
                    }, 300);
                } else {
                    alert("Authorization failed or system error.");
                }
            } catch (e) { alert("Communication link failure."); }
        }
    </script>
</body>

</html>